<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>J.A.R.V.I.S.A coder</title>
<style>
:root{--bg:#626262;--panel:#37393d;--panel2:#2b2e34;--line:#4d5058;--text:#f3f4f8;--muted:#b7bbcb;--acc:#6e64ff;--acc2:#86c5ff;--ok:#4cd08f;--bad:#ff6b7e}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;color:var(--text);background:radial-gradient(1100px 460px at 14% -8%,rgba(145,172,255,.24),transparent 62%),radial-gradient(900px 420px at 115% 105%,rgba(112,84,255,.2),transparent 58%),var(--bg);font-family:"Bahnschrift","Segoe UI Variable Display","Trebuchet MS",sans-serif}
.app{height:100%;padding:12px;display:grid;grid-template-columns:320px 1fr 330px;gap:10px}
.panel{min-height:0;border:1px solid #565966;border-radius:12px;background:linear-gradient(180deg,#3a3d43 0,#35383d 100%)}
.left{display:flex;flex-direction:column;gap:10px;padding:10px}.center{display:flex;flex-direction:column;min-height:0}.right{display:flex;flex-direction:column;min-height:0;padding:10px;position:relative}
.brand{display:flex;align-items:center;gap:10px;padding:2px 2px 4px}.brand .main{font-size:30px;line-height:.9;font-weight:800;letter-spacing:.04em;text-transform:uppercase}.brand .sub{margin-top:3px}
.coder-wordmark{display:block;width:104px;height:auto}
.logo-orb{width:92px;height:92px;position:relative;flex:0 0 auto}.logo-orb .logo-mark,.orb-btn .logo-mark,.orb-btn .orb-glyph{position:absolute;inset:0;width:100%;height:100%}.logo-orb .orb-glyph{width:42%;height:42%;inset:29%}
.workspace{border:1px solid var(--line);border-radius:10px;background:var(--panel2);padding:8px}.workspace-row{display:flex;gap:8px;align-items:center}
.workspace-path{width:100%;border:1px solid #494d5b;border-radius:8px;background:#24272d;color:#f2f3f8;font-size:13px;padding:8px 10px;outline:none;font-family:"Cascadia Code","Consolas",monospace}.workspace-path:focus{border-color:#7e8eff;box-shadow:0 0 0 1px #7e8eff}
.tree{flex:1;min-height:190px;border:1px solid var(--line);border-radius:10px;background:var(--panel2);padding:7px;overflow:auto}
.tree-row{min-height:29px;border-radius:7px;display:flex;align-items:center;gap:8px;padding:0 8px;cursor:pointer;user-select:none}.tree-row:hover{background:#2f3239}.tree-row.active{background:#2a2b3e;outline:1px solid var(--acc)}.tree-row .arrow{width:14px;color:#c0c4d6;text-align:center;font-size:11px;flex:0 0 auto}.tree-row .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:14px}.tree-row.dir .name{color:#d6d9e4}.tree-row.file .name{color:#f7f8ff}
.models{min-height:180px;border:1px solid var(--line);border-radius:10px;background:var(--panel2);padding:8px;display:flex;flex-direction:column}.model-list{overflow:auto;display:flex;flex-direction:column;gap:7px}.model-item{border:1px solid #424654;border-radius:8px;background:#2a2d33;color:#f3f4fa;text-align:left;padding:8px 10px;cursor:pointer;font-size:14px;font-family:"Cascadia Code","Consolas",monospace}.model-item.active{border-color:var(--acc);box-shadow:0 0 0 1px var(--acc) inset}
.tabs{display:flex;align-items:center;gap:6px;margin-bottom:7px;overflow:auto}.tab{border:1px solid #4b4f5d;border-radius:8px;background:#2f3238;color:#f6f7fb;height:31px;padding:0 12px;display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px}.tab.active{border-color:#6f75a0;background:#373b46}.tab .dirty{color:#f5ca74;font-size:12px}.tab-plus{width:31px;height:31px;border:1px solid #4b4f5d;border-radius:8px;background:#2f3238;color:#fff;font-size:22px;line-height:1;cursor:pointer}
.editor-shell{flex:1;min-height:0;border:1px solid #565966;border-radius:10px;background:#34373d;overflow:hidden;position:relative}.editor{width:100%;height:100%;border:0;outline:none;resize:none;background:#34373d;color:#f6f7ff;font-size:14px;line-height:1.42;padding:14px;font-family:"Cascadia Code","Consolas","JetBrains Mono",monospace}.editor-placeholder{position:absolute;inset:0;display:grid;place-items:center;color:#f6f7fb;font-size:58px;font-weight:800;pointer-events:none}.editor-shell.has-file .editor-placeholder{display:none}
.editor-actions{margin-top:8px;display:flex;align-items:center;gap:8px;min-height:36px;flex-wrap:wrap}.btn{border:1px solid #4d5260;border-radius:8px;background:#2e3138;color:#fff;cursor:pointer;font-weight:700;font-size:13px;padding:8px 12px}.btn:hover{filter:brightness(1.06)}.btn.primary{border-color:transparent;background:linear-gradient(135deg,#8cb6ff 0,#6a62ff 100%)}.btn.small{padding:8px 10px;white-space:nowrap}
.is-hidden{display:none!important}
.status{margin-left:auto;font-size:12px;color:var(--muted)}.status.ok{color:var(--ok)}.status.bad{color:var(--bad)}
.panel-head{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:#2b2f36;border-bottom:1px solid #3d424f;font-size:11px;text-transform:uppercase;letter-spacing:.1em;color:#c6cbe0}
.panel-actions{display:flex;align-items:center;gap:6px}
.chat-head{display:flex;align-items:center;gap:8px;padding:6px 6px 8px;border-bottom:1px solid #4b4f5d;background:#2d3037;border-radius:10px 10px 6px 6px;margin-bottom:6px}
.chat-title{flex:1;text-align:center;font-size:13px;font-weight:700;letter-spacing:.04em;color:#eef1ff}
.history-toggle{width:30px;height:30px;border:1px solid #4b4f5d;border-radius:8px;background:#2f3238;color:#e7ebff;display:grid;place-items:center;cursor:pointer;font-size:16px;line-height:1}
.history-toggle:hover{filter:brightness(1.06)}
.history-panel{position:absolute;top:56px;left:10px;right:10px;height:240px;border:1px solid #4b4f5d;border-radius:12px;background:linear-gradient(180deg,#33373e 0,#2d3037 100%);padding:8px;display:none;flex-direction:column;gap:6px;z-index:2}
.right.history-open .history-panel{display:flex}
.right.history-open #chat{opacity:.2;pointer-events:none}
.history-title{font-size:11px;text-transform:uppercase;letter-spacing:.1em;color:#cbd1e8;padding:4px 6px}
.history-list{display:flex;flex-direction:column;gap:6px}
.history-item{display:flex;align-items:center;justify-content:space-between;border:1px solid #424654;border-radius:8px;background:#2a2d33;color:#eef1ff;font-size:12px;padding:6px 8px;cursor:pointer}
.history-item.active{border-color:#6f75a0;background:#363b45}
.history-item .meta{color:#aab0c6;font-size:11px}
.history-spacer{flex:1;display:flex;align-items:center;justify-content:center;opacity:.6}
.history-glyph{width:46px;height:46px}
.chat{flex:1;min-height:0;overflow:auto;padding-right:2px}.msg{display:flex;margin:10px 0}.msg.user{justify-content:flex-end}.msg.assistant{justify-content:flex-start}.bubble{max-width:94%;border-radius:10px;border:1px solid #444957;background:#2c2f35;color:#f4f6ff;padding:10px 12px;font-size:14px;line-height:1.4;white-space:pre-wrap}.msg.user .bubble{background:#26292f}.bubble p{margin:6px 0}.bubble ul,.bubble ol{margin:6px 0 8px 20px}.bubble a{color:#9bb2ff;text-decoration:none}.bubble code{padding:1px 5px;border-radius:6px;border:1px solid #353f63;background:#1f2538;font-size:12px;font-family:"Cascadia Code","Consolas",monospace}
.bubble .code-wrap{margin:8px 0;border:1px solid #373f5f;border-radius:10px;overflow:hidden}.bubble .code-head{padding:7px 9px;border-bottom:1px solid #373f5f;background:#202745;color:#c7d4ff;display:flex;align-items:center;justify-content:space-between;font-size:12px}.bubble .code-copy{border:1px solid #4d5b95;background:#2a345f;color:#eef2ff;border-radius:999px;font-size:11px;padding:3px 8px;cursor:pointer}.bubble pre{margin:0;background:#12182a;color:#e8edff;padding:10px 12px;overflow:auto;font-size:13px;line-height:1.4;font-family:"Cascadia Code","Consolas",monospace}
.bubble .diff-wrap{margin-top:9px;border:1px solid #4a4f62;border-radius:9px;overflow:hidden;background:#202329}.bubble .diff-head{padding:6px 9px;border-bottom:1px solid #404657;font-size:11px;text-transform:uppercase;letter-spacing:.09em;color:#c2c8dc;background:#252933}.bubble .diff-line{display:grid;grid-template-columns:18px 1fr;gap:8px;padding:2px 9px;font-family:"Cascadia Code","Consolas",monospace;font-size:12px;line-height:1.35}.bubble .diff-line .prefix{text-align:center;font-weight:700}.bubble .diff-line .text{white-space:pre-wrap;word-break:break-word}.bubble .diff-line.del{background:rgba(220,64,87,.22);color:#ffd8df}.bubble .diff-line.del .prefix{color:#ff6f85}.bubble .diff-line.add{background:rgba(56,189,118,.22);color:#d6ffe8}.bubble .diff-line.add .prefix{color:#53d791}.bubble .diff-meta{padding:6px 9px;border-top:1px solid #42485b;color:#c4cada;font-size:11px;background:#252933}
.attach-actions{margin-top:8px;display:flex;align-items:center;gap:8px}.attach-chip{border:1px solid #6e68ff;border-radius:999px;background:#272a31;color:#ecedff;font-size:12px;padding:5px 10px;cursor:pointer;display:inline-flex;align-items:center;gap:7px}.attach-chip .clip-icon{width:11px;height:11px;display:block}.attach-info{margin-top:6px;min-height:18px;font-size:12px;color:#b9bfd2}
.composer{margin-top:6px;border:1px solid #6861ff;border-radius:12px;background:#2b2e35;padding:6px;display:flex;align-items:flex-end;gap:6px}.composer textarea{flex:1;border:0;outline:none;resize:none;min-height:40px;max-height:140px;padding:8px;background:transparent;color:#fff;font-size:14px;line-height:1.35;font-family:"Bahnschrift","Segoe UI Variable Display",sans-serif}
.orb-btn{position:relative;flex:0 0 auto;width:52px;height:52px;border:0;padding:0;background:transparent;cursor:pointer}.orb-btn .orb-glyph{z-index:1;width:43%;height:43%;inset:28.5%}.send-orb .icon-pause,.send-orb .icon-send{display:none}.send-orb .icon-logo{display:block}.send-orb.has-text .icon-logo{display:none}.send-orb.has-text .icon-send{display:block}.send-orb.is-running .icon-logo,.send-orb.is-running .icon-send{display:none}.send-orb.is-running .icon-pause{display:block}
.empty-note{padding:9px;color:#bcc3d6;font-size:13px}
*{scrollbar-width:thin;scrollbar-color:#505562 #252930}
*::-webkit-scrollbar{width:10px;height:10px}
*::-webkit-scrollbar-track{background:#252930;border-radius:999px}
*::-webkit-scrollbar-thumb{background:#505562;border-radius:999px;border:2px solid #252930}
*::-webkit-scrollbar-thumb:hover{background:#666d7c}
*::-webkit-scrollbar-corner{background:#252930}
.composer textarea{scrollbar-gutter:stable both-edges}
@media (max-width:1320px){.app{grid-template-columns:295px 1fr 310px}.brand .main{font-size:26px}.coder-wordmark{width:88px}.logo-orb{width:78px;height:78px}.orb-btn{width:46px;height:46px}.editor-placeholder{font-size:48px}}
@media (max-width:1040px){.app{height:auto;min-height:100%;grid-template-columns:1fr;grid-template-rows:auto auto auto}.tree{max-height:310px}.center{min-height:54vh}}
</style>
</head>
<body>
<div class="app">
  <aside class="panel left">
    <div class="brand">
      <div class="logo-orb" aria-hidden="true">
        <svg class="logo-mark" viewBox="0 0 598 598" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M299 4C461.924 4 594 136.076 594 299C594 461.924 461.924 594 299 594C136.076 594 4 461.924 4 299C4 136.076 136.076 4 299 4Z" fill="url(#logoFill)" stroke="url(#logoStroke)" stroke-width="8"/>
          <path d="M297.74 95.8828C313.9 95.8828 328.746 112.738 340.43 140.902C364.64 122.34 385.934 115.161 399.934 123.243C413.929 131.324 418.359 153.345 414.395 183.581C444.634 179.615 466.658 184.045 474.739 198.042C482.823 212.044 475.637 233.342 457.066 257.559C485.25 269.245 502.117 284.095 502.117 300.261C502.117 316.419 485.266 331.263 457.105 342.946C475.649 367.144 482.819 388.426 474.74 402.419C466.659 416.415 444.635 420.845 414.396 416.879C418.363 447.119 413.933 469.144 399.937 477.226C385.94 485.306 364.653 478.129 340.449 459.575C328.762 487.769 313.909 504.643 297.74 504.643C281.574 504.642 266.724 487.775 255.038 459.592C230.836 478.144 209.55 485.32 195.554 477.239C181.555 469.157 177.126 447.126 181.096 416.88C150.853 420.848 128.825 416.419 120.743 402.421C112.665 388.428 119.835 367.147 138.378 342.95C110.213 331.266 93.3574 316.421 93.3574 300.261C93.3575 284.094 110.227 269.241 138.415 257.555C119.846 233.34 112.661 212.042 120.744 198.04C128.826 184.042 150.854 179.612 181.098 183.58C177.13 153.338 181.56 131.312 195.557 123.229C209.555 115.147 230.848 122.326 255.057 140.886C266.74 112.731 281.584 95.8832 297.74 95.8828Z" fill="url(#logoCore)"/>
        </svg>
      </div>
      <div>
        <div class="main">J.A.R.V.I.S.A.</div>
        <div class="sub" aria-label="coder">
          <svg class="coder-wordmark" viewBox="0 0 562 139" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M23.2 133.599V115.599H5V59.3992H23.2V41.1992H79.6V59.3992H98V79.1992H77.6V61.1992H25.2V113.599H77.6V95.3992H98V115.599H79.6V133.599H23.2ZM134.333 133.599V115.599H116.133V59.3992H134.333V41.1992H190.733V59.3992H209.133V115.599H190.733V133.599H134.333ZM136.333 113.599H188.733V61.1992H136.333V113.599ZM251.52 133.599V115.599H233.32V59.3992H251.52V41.1992H306.12V4.99921H326.32V115.599H307.92V133.599H251.52ZM253.52 113.599H305.92V61.1992H253.52V113.599ZM364.802 133.599V115.599H346.602V59.3992H364.802V41.1992H421.202V59.3992H439.602V79.1992H419.202V61.1992H366.802V77.1992H403.202V97.3992H366.802V113.599H419.202V95.1992H439.602V115.399H421.202V133.599H364.802ZM463.789 133.599V59.3992H481.989V41.1992H538.389V59.3992H556.789V79.1992H536.389V61.1992H483.989V133.599H463.789Z" fill="white"/>
            <path d="M23.2 133.599H18.2V138.599H23.2V133.599ZM23.2 115.599H28.2V110.599H23.2V115.599ZM5 115.599H4.76837e-07V120.599H5V115.599ZM5 59.3992V54.3992H4.76837e-07V59.3992H5ZM23.2 59.3992V64.3992H28.2V59.3992H23.2ZM23.2 41.1992V36.1992H18.2V41.1992H23.2ZM79.6 41.1992H84.6V36.1992H79.6V41.1992ZM79.6 59.3992H74.6V64.3992H79.6V59.3992ZM98 59.3992H103V54.3992H98V59.3992ZM98 79.1992V84.1992H103V79.1992H98ZM77.6 79.1992H72.6V84.1992H77.6V79.1992ZM77.6 61.1992H82.6V56.1992H77.6V61.1992ZM25.2 61.1992V56.1992H20.2V61.1992H25.2ZM25.2 113.599H20.2V118.599H25.2V113.599ZM77.6 113.599V118.599H82.6V113.599H77.6ZM77.6 95.3992V90.3992H72.6V95.3992H77.6ZM98 95.3992H103V90.3992H98V95.3992ZM98 115.599V120.599H103V115.599H98ZM79.6 115.599V110.599H74.6V115.599H79.6ZM79.6 133.599V138.599H84.6V133.599H79.6ZM23.2 133.599H28.2V115.599H23.2H18.2V133.599H23.2ZM23.2 115.599V110.599H5V115.599V120.599H23.2V115.599ZM5 115.599H10V59.3992H5H4.76837e-07V115.599H5ZM5 59.3992V64.3992H23.2V59.3992V54.3992H5V59.3992ZM23.2 59.3992H28.2V41.1992H23.2H18.2V59.3992H23.2ZM23.2 41.1992V46.1992H79.6V41.1992V36.1992H23.2V41.1992ZM79.6 41.1992H74.6V59.3992H79.6H84.6V41.1992H79.6ZM79.6 59.3992V64.3992H98V59.3992V54.3992H79.6V59.3992ZM98 59.3992H93V79.1992H98H103V59.3992H98ZM98 79.1992V74.1992H77.6V79.1992V84.1992H98V79.1992ZM77.6 79.1992H82.6V61.1992H77.6H72.6V79.1992H77.6ZM77.6 61.1992V56.1992H25.2V61.1992V66.1992H77.6V61.1992ZM25.2 61.1992H20.2V113.599H25.2H30.2V61.1992H25.2ZM25.2 113.599V118.599H77.6V113.599V108.599H25.2V113.599ZM77.6 113.599H82.6V95.3992H77.6H72.6V113.599H77.6ZM77.6 95.3992V100.399H98V95.3992V90.3992H77.6V95.3992ZM98 95.3992H93V115.599H98H103V95.3992H98ZM98 115.599V110.599H79.6V115.599V120.599H98V115.599ZM79.6 115.599H74.6V133.599H79.6H84.6V115.599H79.6ZM79.6 133.599V128.599H23.2V133.599V138.599H79.6V133.599ZM134.333 133.599H129.333V138.599H134.333V133.599ZM134.333 115.599H139.333V110.599H134.333V115.599ZM116.133 115.599H111.133V120.599H116.133V115.599ZM116.133 59.3992V54.3992H111.133V59.3992H116.133ZM134.333 59.3992V64.3992H139.333V59.3992H134.333ZM134.333 41.1992V36.1992H129.333V41.1992H134.333ZM190.733 41.1992H195.733V36.1992H190.733V41.1992ZM190.733 59.3992H185.733V64.3992H190.733V59.3992ZM209.133 59.3992H214.133V54.3992H209.133V59.3992ZM209.133 115.599V120.599H214.133V115.599H209.133ZM190.733 115.599V110.599H185.733V115.599H190.733ZM190.733 133.599V138.599H195.733V133.599H190.733ZM136.333 113.599H131.333V118.599H136.333V113.599ZM188.733 113.599V118.599H193.733V113.599H188.733ZM188.733 61.1992H193.733V56.1992H188.733V61.1992ZM136.333 61.1992V56.1992H131.333V61.1992H136.333ZM134.333 133.599H139.333V115.599H134.333H129.333V133.599H134.333ZM134.333 115.599V110.599H116.133V115.599V120.599H134.333V115.599ZM116.133 115.599H121.133V59.3992H116.133H111.133V115.599H116.133ZM116.133 59.3992V64.3992H134.333V59.3992V54.3992H116.133V59.3992ZM134.333 59.3992H139.333V41.1992H134.333H129.333V59.3992H134.333ZM134.333 41.1992V46.1992H190.733V41.1992V36.1992H134.333V41.1992ZM190.733 41.1992H185.733V59.3992H190.733H195.733V41.1992H190.733ZM190.733 59.3992V64.3992H209.133V59.3992V54.3992H190.733V59.3992ZM209.133 59.3992H204.133V115.599H209.133H214.133V59.3992H209.133ZM209.133 115.599V110.599H190.733V115.599V120.599H209.133V115.599ZM190.733 115.599H185.733V133.599H190.733H195.733V115.599H190.733ZM190.733 133.599V128.599H134.333V133.599V138.599H190.733V133.599ZM136.333 113.599V118.599H188.733V113.599V108.599H136.333V113.599ZM188.733 113.599H193.733V61.1992H188.733H183.733V113.599H188.733ZM188.733 61.1992V56.1992H136.333V61.1992V66.1992H188.733V61.1992ZM136.333 61.1992H131.333V113.599H136.333H141.333V61.1992H136.333ZM251.52 133.599H246.52V138.599H251.52V133.599ZM251.52 115.599H256.52V110.599H251.52V115.599ZM233.32 115.599H228.32V120.599H233.32V115.599ZM233.32 59.3992V54.3992H228.32V59.3992H233.32ZM251.52 59.3992V64.3992H256.52V59.3992H251.52ZM251.52 41.1992V36.1992H246.52V41.1992H251.52ZM306.12 41.1992V46.1992H311.12V41.1992H306.12ZM306.12 4.99921V-0.000793457H301.12V4.99921H306.12ZM326.32 4.99921H331.32V-0.000793457H326.32V4.99921ZM326.32 115.599V120.599H331.32V115.599H326.32ZM307.92 115.599V110.599H302.92V115.599H307.92ZM307.92 133.599V138.599H312.92V133.599H307.92ZM253.52 113.599H248.52V118.599H253.52V113.599ZM305.92 113.599V118.599H310.92V113.599H305.92ZM305.92 61.1992H310.92V56.1992H305.92V61.1992ZM253.52 61.1992V56.1992H248.52V61.1992H253.52ZM251.52 133.599H256.52V115.599H251.52H246.52V133.599H251.52ZM251.52 115.599V110.599H233.32V115.599V120.599H251.52V115.599ZM233.32 115.599H238.32V59.3992H233.32H228.32V115.599H233.32ZM233.32 59.3992V64.3992H251.52V59.3992V54.3992H233.32V59.3992ZM251.52 59.3992H256.52V41.1992H251.52H246.52V59.3992H251.52ZM251.52 41.1992V46.1992H306.12V41.1992V36.1992H251.52V41.1992ZM306.12 41.1992H311.12V4.99921H306.12H301.12V41.1992H306.12ZM306.12 4.99921V9.99921H326.32V4.99921V-0.000793457H306.12V4.99921ZM326.32 4.99921H321.32V115.599H326.32H331.32V4.99921H326.32ZM326.32 115.599V110.599H307.92V115.599V120.599H326.32V115.599ZM307.92 115.599H302.92V133.599H307.92H312.92V115.599H307.92ZM307.92 133.599V128.599H251.52V133.599V138.599H307.92V133.599ZM253.52 113.599V118.599H305.92V113.599V108.599H253.52V113.599ZM305.92 113.599H310.92V61.1992H305.92H300.92V113.599H305.92ZM305.92 61.1992V56.1992H253.52V61.1992V66.1992H305.92V61.1992ZM253.52 61.1992H248.52V113.599H253.52H258.52V61.1992H253.52ZM364.802 133.599H359.802V138.599H364.802V133.599ZM364.802 115.599H369.802V110.599H364.802V115.599ZM346.602 115.599H341.602V120.599H346.602V115.599ZM346.602 59.3992V54.3992H341.602V59.3992H346.602ZM364.802 59.3992V64.3992H369.802V59.3992H364.802ZM364.802 41.1992V36.1992H359.802V41.1992H364.802ZM421.202 41.1992H426.202V36.1992H421.202V41.1992ZM421.202 59.3992H416.202V64.3992H421.202V59.3992ZM439.602 59.3992H444.602V54.3992H439.602V59.3992ZM439.602 79.1992V84.1992H444.602V79.1992H439.602ZM419.202 79.1992H414.202V84.1992H419.202V79.1992ZM419.202 61.1992H424.202V56.1992H419.202V61.1992ZM366.802 61.1992V56.1992H361.802V61.1992H366.802ZM366.802 77.1992H361.802V82.1992H366.802V77.1992ZM403.202 77.1992H408.202V72.1992H403.202V77.1992ZM403.202 97.3992V102.399H408.202V97.3992H403.202ZM366.802 97.3992V92.3992H361.802V97.3992H366.802ZM366.802 113.599H361.802V118.599H366.802V113.599ZM419.202 113.599V118.599H424.202V113.599H419.202ZM419.202 95.1992V90.1992H414.202V95.1992H419.202ZM439.602 95.1992H444.602V90.1992H439.602V95.1992ZM439.602 115.399V120.399H444.602V115.399H439.602ZM421.202 115.399V110.399H416.202V115.399H421.202ZM421.202 133.599V138.599H426.202V133.599H421.202ZM364.802 133.599H369.802V115.599H364.802H359.802V133.599H364.802ZM364.802 115.599V110.599H346.602V115.599V120.599H364.802V115.599ZM346.602 115.599H351.602V59.3992H346.602H341.602V115.599H346.602ZM346.602 59.3992V64.3992H364.802V59.3992V54.3992H346.602V59.3992ZM364.802 59.3992H369.802V41.1992H364.802H359.802V59.3992H364.802ZM364.802 41.1992V46.1992H421.202V41.1992V36.1992H364.802V41.1992ZM421.202 41.1992H416.202V59.3992H421.202H426.202V41.1992H421.202ZM421.202 59.3992V64.3992H439.602V59.3992V54.3992H421.202V59.3992ZM439.602 59.3992H434.602V79.1992H439.602H444.602V59.3992H439.602ZM439.602 79.1992V74.1992H419.202V79.1992V84.1992H439.602V79.1992ZM419.202 79.1992H424.202V61.1992H419.202H414.202V79.1992H419.202ZM419.202 61.1992V56.1992H366.802V61.1992V66.1992H419.202V61.1992ZM366.802 61.1992H361.802V77.1992H366.802H371.802V61.1992H366.802ZM366.802 77.1992V82.1992H403.202V77.1992V72.1992H366.802V77.1992ZM403.202 77.1992H398.202V97.3992H403.202H408.202V77.1992H403.202ZM403.202 97.3992V92.3992H366.802V97.3992V102.399H403.202V97.3992ZM366.802 97.3992H361.802V113.599H366.802H371.802V97.3992H366.802ZM366.802 113.599V118.599H419.202V113.599V108.599H366.802V113.599ZM419.202 113.599H424.202V95.1992H419.202H414.202V113.599H419.202ZM419.202 95.1992V100.199H439.602V95.1992V90.1992H419.202V95.1992ZM439.602 95.1992H434.602V115.399H439.602H444.602V95.1992H439.602ZM439.602 115.399V110.399H421.202V115.399V120.399H439.602V115.399ZM421.202 115.399H416.202V133.599H421.202H426.202V115.399H421.202ZM421.202 133.599V128.599H364.802V133.599V138.599H421.202V133.599ZM463.789 133.599H458.789V138.599H463.789V133.599ZM463.789 59.3992V54.3992H458.789V59.3992H463.789ZM481.989 59.3992V64.3992H486.989V59.3992H481.989ZM481.989 41.1992V36.1992H476.989V41.1992H481.989ZM538.389 41.1992H543.389V36.1992H538.389V41.1992ZM538.389 59.3992H533.389V64.3992H538.389V59.3992ZM556.789 59.3992H561.789V54.3992H556.789V59.3992ZM556.789 79.1992V84.1992H561.789V79.1992H556.789ZM536.389 79.1992H531.389V84.1992H536.389V79.1992ZM536.389 61.1992H541.389V56.1992H536.389V61.1992ZM483.989 61.1992V56.1992H478.989V61.1992H483.989ZM483.989 133.599V138.599H488.989V133.599H483.989ZM463.789 133.599H468.789V59.3992H463.789H458.789V133.599H463.789ZM463.789 59.3992V64.3992H481.989V59.3992V54.3992H463.789V59.3992ZM481.989 59.3992H486.989V41.1992H481.989H476.989V59.3992H481.989ZM481.989 41.1992V46.1992H538.389V41.1992V36.1992H481.989V41.1992ZM538.389 41.1992H533.389V59.3992H538.389H543.389V41.1992H538.389ZM538.389 59.3992V64.3992H556.789V59.3992V54.3992H538.389V59.3992ZM556.789 59.3992H551.789V79.1992H556.789H561.789V59.3992H556.789ZM556.789 79.1992V74.1992H536.389V79.1992V84.1992H556.789V79.1992ZM536.389 79.1992H541.389V61.1992H536.389H531.389V79.1992H536.389ZM536.389 61.1992V56.1992H483.989V61.1992V66.1992H536.389V61.1992ZM483.989 61.1992H478.989V133.599H483.989H488.989V61.1992H483.989ZM483.989 133.599V128.599H463.789V133.599V138.599H483.989V133.599Z" fill="url(#paint0_linear_173_46)"/>
            <defs>
              <linearGradient id="paint0_linear_173_46" x1="-7" y1="78.1992" x2="602" y2="78.1992" gradientUnits="userSpaceOnUse">
                <stop stop-color="#7EA4FE"/>
                <stop offset="1" stop-color="#6749FF"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
      </div>
    </div>
    <div class="workspace"><div class="workspace-row"><input id="workspacePath" class="workspace-path" placeholder="Путь к рабочей папке" /><button id="applyWorkspaceBtn" class="btn small" type="button">Открыть</button></div></div>
    <div id="tree" class="tree"></div>
    <div class="models"><div id="modelList" class="model-list"></div></div>
  </aside>
  <main class="center">
    <div id="tabs" class="tabs"></div>
    <div id="editorShell" class="editor-shell">
      <textarea id="editor" class="editor" spellcheck="false"></textarea>
      <div class="editor-placeholder">редактор кода</div>
    </div>
    <div class="editor-actions">
      <button id="saveBtn" class="btn primary" type="button">Сохранить (Ctrl+S)</button>
      <button id="reloadBtn" class="btn" type="button">Перечитать файл</button>
      <label class="btn" style="display:flex;align-items:center;gap:8px;"><input id="autoApply" type="checkbox" checked />авто-применение</label>
      <span id="status" class="status">готово</span>
    </div>
    
  </main>

  <section id="rightPanel" class="panel right">
    <div class="chat-head">
      <button id="historyToggle" class="history-toggle" type="button" aria-expanded="false" title="История чатов">←</button>
      <div id="chatTitle" class="chat-title">Название чата</div>
    </div>
    <div id="historyPanel" class="history-panel" aria-hidden="true">
      <div class="history-title">История чатов</div>
      <div id="historyList" class="history-list"></div>
      <div class="history-spacer" aria-hidden="true">
        <svg class="history-glyph" viewBox="0 0 693 693" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M346.205 0C373.583 -1.30391e-06 398.734 28.5592 418.527 76.2813C459.532 44.8466 495.597 32.6895 519.309 46.3789C543.018 60.0683 550.521 97.3778 543.802 148.604C595.028 141.884 632.338 149.388 646.027 173.098C659.717 196.809 647.557 232.873 616.12 273.879C663.847 293.673 692.409 318.825 692.409 346.204C692.409 373.583 663.849 398.733 616.125 418.526C647.559 459.53 659.717 495.593 646.027 519.304C632.338 543.014 595.027 550.517 543.801 543.797C550.521 595.024 543.018 632.334 519.308 646.023C495.597 659.713 459.534 647.554 418.529 616.12C398.736 663.847 373.584 692.409 346.205 692.409C318.826 692.409 293.673 663.847 273.879 616.12C232.876 647.553 196.814 659.712 173.104 646.022C149.393 632.333 141.89 595.023 148.609 543.796C97.383 550.516 60.073 543.013 46.3838 519.303C32.6949 495.592 44.8509 459.529 76.2832 418.526C28.5602 398.733 7.06623e-07 373.582 0 346.204C0.000173871 318.825 28.5617 293.673 76.2871 273.879C44.8516 232.874 32.6932 196.81 46.3828 173.099C60.072 149.388 97.3822 141.885 148.608 148.604C141.889 97.3783 149.392 60.0682 173.103 46.3789C196.814 32.6894 232.877 44.8473 273.882 76.2822C293.675 28.5597 318.827 0.000157768 346.205 0Z" fill="#4D5158"/>
        </svg>
      </div>
    </div>
    <div id="chat" class="chat"></div>
    <div class="attach-actions">
      <button id="attachChip" class="attach-chip" type="button">
        <svg class="clip-icon" viewBox="0 0 56 121" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M52.7792 31.2515C53.2761 56.736 52.7792 71.0454 52.7792 96.5114C52.7792 125.163 3 125.162 3 96.5114V18.5179C3 -2.17226 36.1861 -2.17298 36.1861 18.5179V82.1861C36.1861 90.1459 19.5931 90.1459 19.5931 82.1861V31.2515" stroke="#8A93B2" stroke-width="6"/></svg>
        <span>Прикрепить файл</span>
      </button>
    </div>
    <div id="attachInfo" class="attach-info">Файл не прикреплен</div>
    <div class="composer">
      <input id="attachInput" type="file" hidden />
      <textarea id="promptInput" rows="1" placeholder="Напиши что изменить/добавить"></textarea>
      <button id="sendBtn" class="orb-btn send-orb" type="button" title="Отправить (Ctrl+Enter)">
        <svg class="logo-mark icon-logo" viewBox="0 0 598 598" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M299 4C461.924 4 594 136.076 594 299C594 461.924 461.924 594 299 594C136.076 594 4 461.924 4 299C4 136.076 136.076 4 299 4Z" fill="url(#logoFill)" stroke="url(#logoStroke)" stroke-width="8"/>
          <path d="M297.74 95.8828C313.9 95.8828 328.746 112.738 340.43 140.902C364.64 122.34 385.934 115.161 399.934 123.243C413.929 131.324 418.359 153.345 414.395 183.581C444.634 179.615 466.658 184.045 474.739 198.042C482.823 212.044 475.637 233.342 457.066 257.559C485.25 269.245 502.117 284.095 502.117 300.261C502.117 316.419 485.266 331.263 457.105 342.946C475.649 367.144 482.819 388.426 474.74 402.419C466.659 416.415 444.635 420.845 414.396 416.879C418.363 447.119 413.933 469.144 399.937 477.226C385.94 485.306 364.653 478.129 340.449 459.575C328.762 487.769 313.909 504.643 297.74 504.643C281.574 504.642 266.724 487.775 255.038 459.592C230.836 478.144 209.55 485.32 195.554 477.239C181.555 469.157 177.126 447.126 181.096 416.88C150.853 420.848 128.825 416.419 120.743 402.421C112.665 388.428 119.835 367.147 138.378 342.95C110.213 331.266 93.3574 316.421 93.3574 300.261C93.3575 284.094 110.227 269.241 138.415 257.555C119.846 233.34 112.661 212.042 120.744 198.04C128.826 184.042 150.854 179.612 181.098 183.58C177.13 153.338 181.56 131.312 195.557 123.229C209.555 115.147 230.848 122.326 255.057 140.886C266.74 112.731 281.584 95.8832 297.74 95.8828Z" fill="url(#logoCore)"/>
        </svg>
        <svg class="orb-glyph icon-send" viewBox="0 0 703 751" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M68.5039 304.938L351.435 86.5352M351.435 86.5352L634.367 304.938M351.435 86.5352V682.18" stroke="url(#sendGrad)" stroke-width="137" stroke-linecap="round"/></svg>
        <svg class="orb-glyph icon-pause" viewBox="0 0 510 637" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M150.439 0C175.292 0 195.439 20.1472 195.439 45V591.482C195.439 616.335 175.292 636.482 150.439 636.482H45C20.1472 636.482 0 616.335 0 591.482V45C0 20.1472 20.1472 0 45 0H150.439ZM464.995 0C489.848 0 509.995 20.1472 509.995 45V591.482C509.995 616.335 489.848 636.482 464.995 636.482H359.556C334.703 636.482 314.556 616.335 314.556 591.482V45C314.556 20.1473 334.703 0.000115029 359.556 0H464.995Z" fill="url(#pauseGrad)"/></svg>
      </button>
    </div>
  </section>
</div>

<svg width="0" height="0" style="position:absolute;pointer-events:none;opacity:0" aria-hidden="true"><defs>
<linearGradient id="sendGrad" x1="-52.5293" y1="-27.5703" x2="717.471" y2="744.93" gradientUnits="userSpaceOnUse"><stop stop-color="#86C5FF"/><stop offset="1" stop-color="#6131FF"/></linearGradient>
<linearGradient id="pauseGrad" x1="0" y1="0" x2="510" y2="636" gradientUnits="userSpaceOnUse"><stop stop-color="#86C5FF"/><stop offset="1" stop-color="#6131FF"/></linearGradient>
<linearGradient id="logoFill" x1="75.6094" y1="-44.6781" x2="580.817" y2="680.481" gradientUnits="userSpaceOnUse"><stop stop-color="#3D3D3D"/><stop offset="1" stop-color="#1E1E1E"/></linearGradient>
<linearGradient id="logoStroke" x1="0" y1="0" x2="598" y2="598" gradientUnits="userSpaceOnUse"><stop stop-color="#7FA7FF"/><stop offset="1" stop-color="#6E64FF"/></linearGradient>
<linearGradient id="logoCore" x1="154.458" y1="128.647" x2="501.876" y2="571.995" gradientUnits="userSpaceOnUse"><stop stop-color="#80ADFF"/><stop offset="1" stop-color="#6748FF"/></linearGradient>
</defs></svg>

<script>
const state={workspaceRoot:"",provider:"ollama",selectedModel:"",models:[],tabs:[],activePath:"",expandedDirs:new Set(["."]),dirCache:new Map(),currentDir:".",stickBottom:true,streamRunning:false,streamAbortCtrl:null,applyTimer:null,pendingCode:null,attachment:null,chatId:"",chats:[]};
const el={workspacePath:document.getElementById("workspacePath"),applyWorkspaceBtn:document.getElementById("applyWorkspaceBtn"),tree:document.getElementById("tree"),modelList:document.getElementById("modelList"),tabs:document.getElementById("tabs"),editorShell:document.getElementById("editorShell"),editor:document.getElementById("editor"),saveBtn:document.getElementById("saveBtn"),reloadBtn:document.getElementById("reloadBtn"),autoApply:document.getElementById("autoApply"),status:document.getElementById("status"),chat:document.getElementById("chat"),promptInput:document.getElementById("promptInput"),sendBtn:document.getElementById("sendBtn"),attachChip:document.getElementById("attachChip"),attachInput:document.getElementById("attachInput"),attachInfo:document.getElementById("attachInfo"),historyToggle:document.getElementById("historyToggle"),historyPanel:document.getElementById("historyPanel"),historyList:document.getElementById("historyList"),chatTitle:document.getElementById("chatTitle"),rightPanel:document.getElementById("rightPanel")};
const setStatus=(t,m="idle")=>{el.status.textContent=t;el.status.classList.toggle("ok",m==="ok");el.status.classList.toggle("bad",m==="bad")};
const setSendButtonState=r=>{el.sendBtn.classList.toggle("is-running",!!r);el.sendBtn.title=r?"Остановить генерацию":"Отправить (Ctrl+Enter)"};
const updatePromptButtonState=()=>{el.sendBtn.classList.toggle("has-text",(el.promptInput.value||"").trim().length>0)};
const humanSize=b=>{b=Number(b||0);if(b<1024)return b+" B";if(b<1048576)return(b/1024).toFixed(1)+" KB";return(b/1048576).toFixed(2)+" MB"};
const esc=s=>String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
async function fetchJson(path,opts={}){const r=await fetch(path,{method:opts.method||"GET",headers:{"Content-Type":"application/json"},body:opts.body?JSON.stringify(opts.body):null});const txt=await r.text();let d={};try{d=txt?JSON.parse(txt):{}}catch{d={raw:txt}}if(!r.ok)throw new Error(d.error||d.message||("HTTP "+r.status));return d}
async function fetchTextStream(path,body,signal){const r=await fetch(path,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body),signal});if(!r.ok){const t=await r.text();throw new Error(t||("HTTP "+r.status))}if(!r.body||!r.body.getReader)throw new Error("Streaming unsupported in this browser");return r.body.getReader()}
const normPath=(d,n)=>(!d||d===".")?n:(d.replace(/\/+$/,"")+"/"+n).replace(/\/+/g,"/");
const activeTab=()=>state.tabs.find(t=>t.path===state.activePath)||null;
const updateContextActions=()=>{};
function resetWorkspaceState(){state.tabs=[];state.activePath="";state.currentDir=".";state.expandedDirs=new Set(["."]);state.dirCache.clear();state.pendingCode=null;if(state.applyTimer){clearTimeout(state.applyTimer);state.applyTimer=null}el.tabs.innerHTML="";el.tree.innerHTML="";el.editor.value="";el.editorShell.classList.remove("has-file");updateContextActions()}
function renderTabs(){el.tabs.innerHTML="";state.tabs.forEach(tab=>{const b=document.createElement("button");b.className="tab"+(tab.path===state.activePath?" active":"");b.type="button";b.innerHTML=`<span>${esc(tab.name)}</span>${tab.dirty?'<span class="dirty">●</span>':''}`;b.onclick=()=>setActiveTab(tab.path);el.tabs.appendChild(b)});const p=document.createElement("button");p.className="tab-plus";p.type="button";p.title="Новый файл";p.textContent="+";p.onclick=createNewFile;el.tabs.appendChild(p)}
function setActiveTab(path){const tab=state.tabs.find(t=>t.path===path);if(!tab)return;state.activePath=path;el.editor.value=tab.content;el.editorShell.classList.add("has-file");renderTabs();renderTree();updateContextActions()}
const isFileOpen=path=>state.tabs.some(t=>t.path===path);
async function openFile(path){if(isFileOpen(path)){setActiveTab(path);return}const d=await fetchJson("/coder/fs/read",{method:"POST",body:{path}});state.tabs.push({path:d.path,name:d.path.split("/").pop(),content:d.content||"",dirty:false});setActiveTab(d.path)}
async function reloadActiveFile(){const t=activeTab();if(!t)return;const d=await fetchJson("/coder/fs/read",{method:"POST",body:{path:t.path}});t.content=d.content||"";t.dirty=false;if(state.activePath===t.path)el.editor.value=t.content;renderTabs();setStatus("перечитано","ok")}
async function saveActiveFile(){const t=activeTab();if(!t)return;t.content=el.editor.value;await fetchJson("/coder/fs/write",{method:"POST",body:{path:t.path,content:t.content}});t.dirty=false;renderTabs();setStatus("сохранено","ok")}
function setEditorDirty(){const t=activeTab();if(!t)return;t.content=el.editor.value;t.dirty=true;renderTabs()}
async function createNewFile(){const name=prompt("Имя нового файла (например: example.py)");if(!name)return;const path=normPath(state.currentDir,name.trim());await fetchJson("/coder/fs/new",{method:"POST",body:{path,kind:"file"}});await ensureDirLoaded(state.currentDir,true);renderTree();await openFile(path)}
async function ensureDirLoaded(path,force=false){if(!force&&state.dirCache.has(path))return;const d=await fetchJson("/coder/fs/list?path="+encodeURIComponent(path));state.dirCache.set(path,d.entries||[])}
async function toggleDir(path){if(state.expandedDirs.has(path))state.expandedDirs.delete(path);else{state.expandedDirs.add(path);await ensureDirLoaded(path)}state.currentDir=path;renderTree()}
function renderTree(){el.tree.innerHTML="";const draw=(dir,depth)=>{(state.dirCache.get(dir)||[]).forEach(item=>{const row=document.createElement("div");row.className="tree-row "+item.type+(item.path===state.activePath?" active":"");row.style.paddingLeft=(8+depth*14)+"px";const a=document.createElement("span");a.className="arrow";a.textContent=item.type==="dir"?(state.expandedDirs.has(item.path)?"▾":"▸"):"";const n=document.createElement("span");n.className="name";n.textContent=item.name;row.append(a,n);el.tree.appendChild(row);row.onclick=async()=>{if(item.type==="dir")await toggleDir(item.path);else await openFile(item.path)};if(item.type==="dir"&&state.expandedDirs.has(item.path))draw(item.path,depth+1)})};draw(".",0)}
function renderModels(){el.modelList.innerHTML="";if(!state.models.length){el.modelList.innerHTML='<div class="empty-note">модели не найдены</div>';return}state.models.forEach(name=>{const b=document.createElement("button");b.className="model-item"+(name===state.selectedModel?" active":"");b.type="button";b.textContent=name;b.onclick=async()=>{state.selectedModel=name;renderModels();try{await fetchJson("/select-model",{method:"POST",body:{model:name}});setStatus("модель выбрана: "+name,"ok")}catch(e){setStatus("ошибка модели: "+e.message,"bad")}};el.modelList.appendChild(b)})}
const isChatAtBottom=()=>{const s=el.chat,max=s.scrollHeight-s.clientHeight;return max<=0||s.scrollTop>=max-48};
const scrollChat=(force=false)=>{if(force||state.stickBottom)el.chat.scrollTop=el.chat.scrollHeight};
function extractLastCodeBlock(text){const re=/```([a-zA-Z0-9_+\-.]*)\n?([\s\S]*?)```/g;let m,last=null;while((m=re.exec(text))!==null)last={lang:(m[1]||"").trim(),code:(m[2]||"").replace(/\n$/,"")};return last}
const splitLines=t=>String(t||"").replace(/\r\n?/g,"\n").split("\n");
function buildDiffOps(oldText,newText){const A=splitLines(oldText),B=splitLines(newText),n=A.length,m=B.length;if(n*m>180000){const o=[];for(const l of A)o.push({type:"del",text:l});for(const l of B)o.push({type:"add",text:l});return o}const dp=Array(n+1);for(let i=0;i<=n;i++)dp[i]=new Uint32Array(m+1);for(let i=n-1;i>=0;i--)for(let j=m-1;j>=0;j--)dp[i][j]=A[i]===B[j]?dp[i+1][j+1]+1:Math.max(dp[i+1][j],dp[i][j+1]);const out=[];let i=0,j=0;while(i<n&&j<m){if(A[i]===B[j]){out.push({type:"ctx",text:A[i]});i++;j++;continue}if(dp[i+1][j]>=dp[i][j+1]){out.push({type:"del",text:A[i++]})}else{out.push({type:"add",text:B[j++]})}}while(i<n)out.push({type:"del",text:A[i++]});while(j<m)out.push({type:"add",text:B[j++]});return out}
function renderDiffBlock(oldText,newText){if(typeof oldText!=="string")return"";const ops=buildDiffOps(oldText,newText),ch=ops.filter(x=>x.type!=="ctx");if(!ch.length)return"";const max=220,rows=[];for(let i=0;i<ch.length&&i<max;i++){const op=ch[i],cls=op.type==="add"?"add":"del",sign=op.type==="add"?"+":"-",txt=op.text===""?" ":op.text;rows.push(`<div class="diff-line ${cls}"><span class="prefix">${sign}</span><span class="text">${esc(txt)}</span></div>`)}const tail=ch.length>max?`<div class="diff-meta">Показаны первые ${max} строк изменений из ${ch.length}</div>`:"";return `<div class="diff-wrap"><div class="diff-head">Изменения</div>${rows.join("")}${tail}</div>`}
function renderProse(text){let s=esc(text).replace(/\r\n?/g,"\n");s=s.replace(/`([^`\n]+)`/g,"<code>$1</code>").replace(/(\*\*|__)(.+?)\1/g,"<strong>$2</strong>").replace(/(^|[^*])\*(?!\s)([^*]+?)\*(?!\*)/g,"$1<em>$2</em>").replace(/(^|[^_])_(?!\s)([^_]+?)_(?!_)/g,"$1<em>$2</em>").replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');const lines=s.split("\n"),out=[];let i=0;while(i<lines.length){const t=lines[i].trim();if(!t){i++;continue}if(/^\s*[-*]\s+/.test(t)){const items=[];while(i<lines.length&&/^\s*[-*]\s+/.test(lines[i].trim()))items.push(lines[i++].trim().replace(/^\s*[-*]\s+/,""));out.push(`<ul>${items.map(x=>`<li>${x}</li>`).join("")}</ul>`);continue}if(/^\s*\d+\.\s+/.test(t)){const items=[];while(i<lines.length&&/^\s*\d+\.\s+/.test(lines[i].trim()))items.push(lines[i++].trim().replace(/^\s*\d+\.\s+/,""));out.push(`<ol>${items.map(x=>`<li>${x}</li>`).join("")}</ol>`);continue}const p=[];while(i<lines.length&&lines[i].trim()&&!/^\s*[-*]\s+/.test(lines[i].trim())&&!/^\s*\d+\.\s+/.test(lines[i].trim()))p.push(lines[i++].trim());out.push(`<p>${p.join("<br>")}</p>`)}return out.join("")}
function renderAssistantMessage(text,baseCode=null){const src=String(text||""),parts=[],m=[...src.matchAll(/```([a-zA-Z0-9_+\-.]*)\n?([\s\S]*?)```/g)];if(!m.length)return renderProse(src);let last=0;m.forEach((x,idx)=>{const prose=src.slice(last,x.index);if(prose.trim())parts.push(renderProse(prose));const lang=esc((x[1]||"code").trim()||"code"),codeRaw=x[2]||"",codeEsc=esc(codeRaw);parts.push(`<div class="code-wrap"><div class="code-head"><span>${lang}</span><button class="code-copy" type="button">Копировать</button></div><pre><code>${codeEsc}</code></pre></div>`);if(idx===m.length-1){const d=renderDiffBlock(baseCode,codeRaw);if(d)parts.push(d)}last=x.index+x[0].length});const tail=src.slice(last);if(tail.trim())parts.push(renderProse(tail));return parts.join("")}
function appendMessage(role,raw="",extras={}){const w=document.createElement("div");w.className="msg "+(role==="user"?"user":"assistant");const b=document.createElement("div");b.className="bubble";w.appendChild(b);el.chat.appendChild(w);const msg={wrap:w,bubble:b,role,raw,baseCode:typeof extras.baseCode==="string"?extras.baseCode:null};refreshMessageBubble(msg);scrollChat(true);return msg}
function refreshMessageBubble(m){if(m.role==="assistant")m.bubble.innerHTML=renderAssistantMessage(m.raw,m.baseCode);else m.bubble.textContent=m.raw}
function queueApplyCode(code){state.pendingCode=code;if(state.applyTimer)return;state.applyTimer=setTimeout(()=>{state.applyTimer=null;const p=state.pendingCode;state.pendingCode=null;if(p==null)return;const t=activeTab();if(!t)return;t.content=p;t.dirty=true;if(state.activePath===t.path)el.editor.value=p;renderTabs()},120)}
const stopStreaming=()=>{if(state.streamAbortCtrl)state.streamAbortCtrl.abort()};
function buildPromptWithAttachment(prompt){if(!state.attachment)return prompt;const a=state.attachment,head=`[Вложение: ${a.name}, ${humanSize(a.size)}${a.type?", "+a.type:""}]`;if(!a.text)return`${prompt}\n\n${head}`;return`${prompt}\n\n${head}\n${a.text}${a.truncated?"\n[Текст обрезан из-за лимита длины]":""}`}
const userPromptPreview=p=>state.attachment?`${p}\n\n[файл: ${state.attachment.name}]`:p;
function updateAttachmentInfo(){if(!state.attachment){el.attachInfo.textContent="Файл не прикреплен";return}const i=`${state.attachment.name} (${humanSize(state.attachment.size)})`;el.attachInfo.textContent=state.attachment.text?(state.attachment.truncated?`${i}, текст обрезан`:`${i}, текст добавится в запрос`):`${i}, будет отправлено мета-описание`}
async function handleFileAttach(file){if(!file){state.attachment=null;updateAttachmentInfo();return}const textLike=file.type.startsWith("text/")||/\.(py|js|ts|tsx|jsx|html|css|json|md|txt|xml|yaml|yml|sql|sh|bat|ps1|toml|ini)$/i.test(file.name);let text="",tr=false;if(textLike){text=await file.text();if(text.length>20000){text=text.slice(0,20000);tr=true}}state.attachment={name:file.name,size:file.size,type:file.type||"",text,truncated:tr};updateAttachmentInfo()}
const CHAT_STORAGE_KEY="coder_chat_id";
const setChatTitle=t=>{if(!el.chatTitle)return;el.chatTitle.textContent=(t||"Новый чат")};
const clearChatView=()=>{el.chat.innerHTML=""};
function formatRelativeTime(ts){const now=Math.floor(Date.now()/1000);const diff=Math.max(0,now-Number(ts||0));if(diff<10)return"только что";if(diff<60)return`${diff} сек назад`;const min=Math.floor(diff/60);if(min<60)return`${min} мин назад`;const hr=Math.floor(min/60);if(hr<24)return`${hr} ч назад`;const day=Math.floor(hr/24);if(day<30)return`${day} дн назад`;const mon=Math.floor(day/30);if(mon<12)return`${mon} мес назад`;const yr=Math.floor(mon/12);return`${yr} г назад`}
async function fetchChatList(){const d=await fetchJson("/coder/chats/list");state.chats=d.chats||[];return state.chats}
function renderHistoryList(){if(!el.historyList)return;el.historyList.innerHTML="";if(!state.chats.length){el.historyList.innerHTML='<div class="empty-note">история пустая</div>';return}state.chats.forEach(c=>{const item=document.createElement("div");item.className="history-item"+(c.id===state.chatId?" active":"");item.innerHTML=`<span>${esc(c.title||"Новый чат")}</span><span class="meta">${formatRelativeTime(c.last_used)}</span>`;item.onclick=async()=>{await loadChat(c.id);if(el.rightPanel)el.rightPanel.classList.remove("history-open")};el.historyList.appendChild(item)})}
async function createChat(title){const d=await fetchJson("/coder/chats/create",{method:"POST",body:{title:title||"Новый чат"}});state.chatId=d.id;localStorage.setItem(CHAT_STORAGE_KEY,state.chatId);setChatTitle(d.title||"Новый чат");return d}
async function loadChat(id){const d=await fetchJson("/coder/chats/get?id="+encodeURIComponent(id));state.chatId=d.id;localStorage.setItem(CHAT_STORAGE_KEY,state.chatId);setChatTitle(d.title||"Новый чат");clearChatView();(d.messages||[]).forEach(m=>{appendMessage(m.role||"assistant",m.content||"")});await refreshHistory()}
async function ensureChat(){const list=await fetchChatList();const stored=localStorage.getItem(CHAT_STORAGE_KEY)||"";const exists=list.find(c=>c.id===stored);if(exists){await loadChat(stored);return}if(list.length){await loadChat(list[0].id);return}await createChat("Новый чат");await refreshHistory()}
async function appendChatMessage(role,content,titleHint=""){if(!state.chatId)return;const d=await fetchJson("/coder/chats/append",{method:"POST",body:{id:state.chatId,role,content,title_hint:titleHint||""}});if(d&&d.title)setChatTitle(d.title);await refreshHistory()}
async function refreshHistory(){await fetchChatList();renderHistoryList()}
async function runCoderPrompt(){if(state.streamRunning){stopStreaming();return}const prompt=(el.promptInput.value||"").trim();if(!prompt)return;const tab=activeTab();if(!tab){alert("Сначала открой файл в редакторе.");return}if(!state.selectedModel){alert("Выбери coder-модель Ollama.");return}
if(!state.chatId)await ensureChat();appendMessage("user",userPromptPreview(prompt));await appendChatMessage("user",prompt,String(prompt||"").trim().slice(0,80));el.promptInput.value="";updatePromptButtonState();const ai=appendMessage("assistant","...",{baseCode:tab.content});const finalPrompt=buildPromptWithAttachment(prompt);state.streamRunning=true;state.streamAbortCtrl=new AbortController();setSendButtonState(true);setStatus("генерация...","idle");
try{const reader=await fetchTextStream("/coder/stream",{message:finalPrompt,file_path:tab.path,code:tab.content,model:state.selectedModel,provider:"ollama"},state.streamAbortCtrl.signal);const dec=new TextDecoder("utf-8");let acc="";while(true){const {value,done}=await reader.read();if(done)break;const ch=dec.decode(value,{stream:true});if(!ch)continue;acc+=ch;ai.raw=acc;refreshMessageBubble(ai);const b=extractLastCodeBlock(acc);if(b&&el.autoApply.checked)queueApplyCode(b.code);scrollChat()}const tail=dec.decode();if(tail){acc+=tail;ai.raw=acc;refreshMessageBubble(ai);const b=extractLastCodeBlock(acc);if(b&&el.autoApply.checked)queueApplyCode(b.code)}await appendChatMessage("assistant",acc||"");setStatus("готово","ok")}
catch(e){if(e&&e.name==="AbortError"){ai.raw=(!ai.raw||ai.raw==="...")?"Генерация остановлена пользователем.":ai.raw+"\n\n_Генерация остановлена пользователем._";refreshMessageBubble(ai);setStatus("остановлено","bad")}else{ai.raw="Ошибка: "+e.message;refreshMessageBubble(ai);setStatus("ошибка: "+e.message,"bad")}}
finally{state.streamRunning=false;state.streamAbortCtrl=null;setSendButtonState(false);scrollChat(true)}}

async function applyWorkspace(){const raw=(el.workspacePath.value||"").trim();if(!raw)return;setStatus("смена папки...","idle");const d=await fetchJson("/coder/workspace/set",{method:"POST",body:{path:raw}});state.workspaceRoot=d.workspace_root||raw;el.workspacePath.value=state.workspaceRoot;resetWorkspaceState();await ensureDirLoaded(".");renderTree();setStatus("рабочая папка обновлена","ok")}

async function init(){setSendButtonState(false);updateAttachmentInfo();updatePromptButtonState();try{const cfg=await fetchJson("/coder/config");state.workspaceRoot=cfg.workspace_root||"";state.provider=cfg.provider||"ollama";state.selectedModel=cfg.selected_model||"";el.workspacePath.value=state.workspaceRoot||"."}catch(e){setStatus("ошибка конфигурации: "+e.message,"bad")}
try{const d=await fetchJson("/list-models");state.models=d.models||[];if(!state.selectedModel&&state.models.length)state.selectedModel=state.models[0];renderModels()}catch(e){setStatus("ошибка загрузки моделей: "+e.message,"bad")}
try{await ensureDirLoaded(".");renderTree()}catch(e){setStatus("ошибка файлового дерева: "+e.message,"bad")}el.editorShell.classList.remove("has-file");updateContextActions();try{await ensureChat()}catch(e){setStatus("ошибка истории: "+e.message,"bad")}}

el.editor.addEventListener("input",setEditorDirty);
el.saveBtn.addEventListener("click",saveActiveFile);
el.reloadBtn.addEventListener("click",reloadActiveFile);
el.sendBtn.addEventListener("click",runCoderPrompt);
el.promptInput.addEventListener("input",updatePromptButtonState);
el.promptInput.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();runCoderPrompt()}});
el.workspacePath.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();applyWorkspace().catch(err=>setStatus("ошибка папки: "+err.message,"bad"))}});
el.applyWorkspaceBtn.addEventListener("click",()=>applyWorkspace().catch(err=>setStatus("ошибка папки: "+err.message,"bad")));
el.attachChip.addEventListener("click",()=>el.attachInput.click());
el.attachInput.addEventListener("change",async()=>{const f=el.attachInput.files&&el.attachInput.files[0]?el.attachInput.files[0]:null;try{await handleFileAttach(f)}catch(e){setStatus("ошибка вложения: "+e.message,"bad")}});
if(el.historyToggle&&el.rightPanel){el.historyToggle.addEventListener("click",()=>{const open=el.rightPanel.classList.toggle("history-open");el.historyToggle.setAttribute("aria-expanded",open?"true":"false");if(el.historyPanel)el.historyPanel.setAttribute("aria-hidden",open?"false":"true")})}
el.chat.addEventListener("scroll",()=>{state.stickBottom=isChatAtBottom()},{passive:true});
el.chat.addEventListener("click",async e=>{const b=e.target.closest(".code-copy");if(!b)return;const c=b.closest(".code-wrap")?.querySelector("pre code")?.textContent||"";if(!c)return;try{await navigator.clipboard.writeText(c);const p=b.textContent;b.textContent="Скопировано";setTimeout(()=>{b.textContent=p},1100)}catch{alert("Не удалось скопировать код.")}});
document.addEventListener("keydown",e=>{if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="s"){e.preventDefault();saveActiveFile()}if((e.ctrlKey||e.metaKey)&&e.key==="Enter"){e.preventDefault();runCoderPrompt()}});
init();
</script>
</body>
</html>
